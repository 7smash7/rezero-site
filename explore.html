<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Explorer — Re:Zero</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/zero.css">
</head>
<body class="zero" data-skin="lime">
  <div class="container">
    <section class="hero">
      <h1 class="h-hero" style="font-size:3rem;margin:0">EXPLORER</h1>
      <p class="h-sub" style="margin-top:8px">DERNIERS • THÈMES • RECHERCHE</p>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="hd">Filtres</div>
      <div class="bd">
        <div class="row">
          <input id="q" class="input" placeholder="Rechercher un nom de personnage ou @username">
          <div class="row">
            <select id="theme" class="input">
              <option value="">Tous les thèmes</option>
              <option value="subaru">Subaru (sombre/rouge)</option>
              <option value="emilia">Emilia (clair/violet)</option>
              <option value="rem">Rem (bleu/océan)</option>
            </select>
            <select id="order" class="input">
              <option value="new">Plus récents</option>
              <option value="old">Plus anciens</option>
              <option value="name">Nom (A→Z)</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <div id="feed" class="grid-3" style="margin-top:16px"></div>
    <div class="center" style="gap:10px;margin:16px 0">
      <button id="more" class="btn" style="display:none">Charger plus</button>
      <button id="reset" class="btn ghost" style="display:none">Réinitialiser</button>
    </div>
    <div id="empty" class="meta center" style="display:none;margin-bottom:20px">Aucun résultat.</div>
    <p id="err" class="meta" style="color:#ff8aa8"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/nav.js"></script>

  <script>
  (function(){
    const PAGE_SIZE = 12;
    let state = { q:"", theme:"", order:"new", offset:0, loading:false, currentOwnerId:null };

    const $=(id)=>document.getElementById(id);
    const feed=$("feed"), empty=$("empty"), err=$("err"), q=$("q"), theme=$("theme"), order=$("order"), more=$("more"), reset=$("reset");

    q.addEventListener("keyup", debounce(applyFilters, 300));
    theme.addEventListener("change", applyFilters);
    order.addEventListener("change", applyFilters);
    more.addEventListener("click", ()=>load(false));
    reset.addEventListener("click", ()=>{ q.value=""; theme.value=""; order.value="new"; applyFilters(); });

    applyFilters();

    async function applyFilters(){
      state.q=(q.value||"").trim(); state.theme=theme.value; state.order=order.value; state.offset=0; state.currentOwnerId=null;
      feed.innerHTML=""; empty.style.display="none"; err.textContent=""; reset.style.display=(state.q||state.theme||state.order!=="new")?"inline-block":"none";
      if (state.q.startsWith("@")){
        const username=state.q.slice(1).trim();
        if(username){ const { data:p, error:pe } = await sb.from("profiles").select("id").eq("username", username).maybeSingle();
          if(pe){ err.textContent=pe.message; return; } state.currentOwnerId=p?.id || "__no_user__"; }
      }
      await load(true);
    }

    async function load(firstPage){
      if(state.loading) return; state.loading=true; more.disabled=true;
      let q = sb.from("characters").select("id,owner,name,theme,created_at,race,affiliation,magic,strength",{count:"exact"}).eq("published", true);
      if (state.currentOwnerId === "__no_user__"){ renderBatch([], true); state.loading=false; return; }
      if (state.currentOwnerId) q = q.eq("owner", state.currentOwnerId);
      else if (state.q && !state.q.startsWith("@")) q = q.ilike("name", `%${state.q}%`);
      if (state.theme) q = q.eq("theme", state.theme);
      if (state.order==="new") q=q.order("created_at",{ascending:false});
      if (state.order==="old") q=q.order("created_at",{ascending:true});
      if (state.order==="name") q=q.order("name",{ascending:true});
      q = q.range(state.offset, state.offset + PAGE_SIZE - 1);
      const { data: chars, error: cErr } = await q;
      if (cErr){ err.textContent=cErr.message; state.loading=false; return; }

      const owners=[...new Set((chars||[]).map(x=>x.owner).filter(Boolean))];
      let usersById={};
      if (owners.length){
        const { data: profs, error: pErr } = await sb.from("profiles").select("id,username").in("id", owners);
        if (pErr){ err.textContent=pErr.message; state.loading=false; return; }
        usersById = Object.fromEntries((profs||[]).map(p=>[p.id,p]));
      }
      const enriched = (chars||[]).map(c=>({ ...c, owner_username: usersById[c.owner]?.username || null }));
      renderBatch(enriched, firstPage);
      state.offset += (chars||[]).length; more.style.display = (chars && chars.length===PAGE_SIZE) ? "inline-block":"none";
      more.disabled=false; state.loading=false;
    }

    function renderBatch(items, first){
      if (first && items.length===0){ empty.style.display="block"; more.style.display="none"; return; }
      const html = items.map(c => `
        <a class="card" href="character.html?id=${c.id}">
          <div class="bd">
            <div style="font-weight:800">${escapeHTML(c.name)}</div>
            <div class="meta">${new Date(c.created_at).toLocaleString()} • ${escapeHTML(c.theme)}${c.owner_username?` • @${escapeHTML(c.owner_username)}`:''}</div>
            <div class="row" style="margin-top:6px">
              <div class="meta">Race</div><div>${escapeHTML(c.race||"—")}</div>
            </div>
            <div class="row" style="margin-top:6px">
              <div class="meta">Affiliation</div><div>${escapeHTML(c.affiliation||"—")}</div>
            </div>
            <div class="row" style="margin-top:6px">
              <div class="meta">Magie</div><div>${escapeHTML(c.magic||"—")}</div>
            </div>
          </div>
        </a>
      `).join('');
      feed.insertAdjacentHTML("beforeend", html);
    }

    function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
  })();
  </script>
</body>
</html>
