<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profil utilisateur â€“ Re:Zero</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b0f18; --bg2:#141a2e; --txt:#e9eefc; --muted:#9aa4c7;
      --panel:#121829; --panel2:#0f1424; --brd:rgba(255,255,255,.10); --accent:#7c9aff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);color:var(--txt)}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 0}
    .brand{font-weight:700;letter-spacing:.3px}
    .nav a{margin-left:14px}

    .hero{display:grid;grid-template-columns:96px 1fr;gap:14px;align-items:center;background:radial-gradient(ellipse at center, rgba(255,255,255,.06) 0%, transparent 70%);
      border:1px solid var(--brd);border-radius:16px;padding:18px}
    .avatar{width:96px;height:96px;border-radius:16px;background:#1b2235;border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;font-weight:700;color:#9aa4c7}
    .title{font-family:Cinzel,serif;font-weight:700;font-size:28px;letter-spacing:.04em}
    .meta{margin-top:6px;color:var(--muted);font-size:14px}
    .bio{margin-top:10px;color:var(--txt)}

    .section{margin-top:16px}
    .card{background:var(--panel);border:1px solid var(--brd);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .card .hd{padding:16px 18px;border-bottom:1px solid var(--brd);font-weight:700}
    .card .bd{padding:16px 18px}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    .char{display:block;background:var(--panel2);border:1px solid var(--brd);border-radius:12px;padding:12px}
    .char .name{font-weight:700}
    .char .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .empty{color:var(--muted)}
    .err{color:#ff6b6b;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- NAV -->
    <div class="topbar">
      <div class="brand">Re:Zero â€“ Profil</div>
      <div class="nav">
        <a href="index.html">Subaru</a>
        <a href="emilia.html">Emilia</a>
        <a href="rem.html">Rem</a>
        <a href="create.html"><b>CrÃ©er</b></a>
        <a href="account.html">Mon compte</a>
      </div>
    </div>

    <!-- HERO / ENTÃŠTE PROFIL -->
    <section class="hero">
      <div class="avatar" id="u-avatar">ðŸ‘¤</div>
      <div>
        <div class="title" id="u-title">Chargementâ€¦</div>
        <div class="meta">Niveau <span id="u-level">â€”</span> â€¢ <span id="u-username">@user</span></div>
        <div class="bio" id="u-bio"></div>
      </div>
    </section>

    <!-- LISTE DES PERSONNAGES PUBLIÃ‰S -->
    <section class="section card">
      <div class="hd">Personnages publiÃ©s</div>
      <div class="bd">
        <div id="chars" class="grid"></div>
        <div id="empty" class="empty" style="display:none">Aucun personnage publiÃ©.</div>
        <p id="err" class="err"></p>
      </div>
    </section>
  </div>

  <!-- 1) Librairie Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 2) Ton client partagÃ© -->
  <script src="js/config.js"></script>

  <!-- 3) Logique profil public -->
  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const username = (params.get('u') || '').trim();
    const err = document.getElementById('err');

    if(!username){ err.textContent = "ParamÃ¨tre ?u (username) manquant dans l'URL."; return; }

    // 1) Charger le profil public
    const { data: [p], error: pErr } = await sb
      .from('profiles')
      .select('id,display_name,username,bio,level,avatar_url,created_at')
      .eq('username', username);

    if (pErr) { err.textContent = pErr.message; return; }
    if (!p)   { err.textContent = "Profil introuvable."; return; }

    // Injecter l'entÃªte
    document.getElementById('u-title').textContent =
      p.display_name ? `${p.display_name} (@${p.username})` : `@${p.username}`;
    document.getElementById('u-username').textContent = '@' + p.username;
    document.getElementById('u-level').textContent = p.level ?? 'â€”';
    document.getElementById('u-bio').textContent = p.bio || '';

    const av = document.getElementById('u-avatar');
    if (p.avatar_url) {
      av.innerHTML = '';
      const img = document.createElement('img');
      img.src = p.avatar_url;
      img.alt = p.username;
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "cover";
      img.style.borderRadius = "12px";
      av.appendChild(img);
    } else {
      // avatar fallback : initiales
      av.textContent = (p.display_name || p.username || 'U').slice(0,2).toUpperCase();
    }

    // 2) Charger les personnages publiÃ©s
    const { data: chars, error: cErr } = await sb
      .from('characters')
      .select('id,name,theme,created_at')
      .eq('owner', p.id)
      .eq('published', true)
      .order('created_at', { ascending:false });

    if (cErr) { err.textContent = cErr.message; return; }

    const grid = document.getElementById('chars');
    const empty = document.getElementById('empty');

    if (!chars || !chars.length) {
      empty.style.display = 'block';
      return;
    }

    grid.innerHTML = chars.map(c => `
      <a class="char" href="character.html?id=${c.id}">
        <div class="name">${escapeHTML(c.name)}</div>
        <div class="meta">${new Date(c.created_at).toLocaleString()} â€¢ thÃ¨me: ${escapeHTML(c.theme)}</div>
      </a>
    `).join('');

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  })();
  </script>
</body>
<!-- Librairie Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Ton client partagÃ© -->
<script src="js/config.js"></script>
<!-- Navigation dynamique -->
<script src="js/nav.js"></script>
</html>
