<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profil â€” Re:Zero</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/zero.css">
</head>
<body class="zero" data-skin="amethyst">
  <div class="container">
    <section class="hero">
      <div class="center" style="gap:12px;flex-direction:column">
        <div id="u-avatar" style="width:96px;height:96px;border-radius:16px;border:1px solid var(--brd);background:rgba(255,255,255,.06)" class="center">ðŸ‘¤</div>
        <h1 class="h-hero" id="u-title" style="font-size:2.4rem;margin:0">Chargementâ€¦</h1>
        <p class="h-sub" style="margin-top:6px">Niveau <span id="u-level">â€”</span> â€¢ <span id="u-username">@user</span></p>
        <p id="u-bio" class="meta" style="max-width:720px;margin-top:10px"></p>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="hd">Personnages publiÃ©s</div>
      <div class="bd">
        <div id="chars" class="grid-3"></div>
        <div id="empty" class="meta" style="display:none">Aucun personnage publiÃ©.</div>
        <p id="err" class="meta" style="color:#ff8aa8"></p>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/nav.js"></script>

  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const username = (params.get('u') || '').trim();
    const err = document.getElementById('err');
    if(!username){ err.textContent="ParamÃ¨tre ?u manquant."; return; }

    const { data: [p], error: pErr } = await sb.from('profiles').select('id,display_name,username,bio,level,avatar_url').eq('username', username);
    if (pErr){ err.textContent=pErr.message; return; }
    if (!p){ err.textContent="Profil introuvable."; return; }

    document.getElementById('u-title').textContent = p.display_name ? `${p.display_name} (@${p.username})` : `@${p.username}`;
    document.getElementById('u-username').textContent = '@'+p.username;
    document.getElementById('u-level').textContent = p.level ?? 'â€”';
    document.getElementById('u-bio').textContent = p.bio || '';

    const av = document.getElementById('u-avatar');
    if (p.avatar_url){
      av.innerHTML = ''; const img = document.createElement('img');
      img.src = p.avatar_url; img.alt = p.username; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.borderRadius='14px';
      av.appendChild(img);
    } else {
      av.textContent = (p.display_name || p.username || 'U').slice(0,2).toUpperCase();
    }

    const { data: chars, error: cErr } = await sb.from('characters').select('id,name,theme,created_at').eq('owner', p.id).eq('published', true).order('created_at',{ascending:false});
    if (cErr){ err.textContent=cErr.message; return; }

    const grid = document.getElementById('chars'); const empty = document.getElementById('empty');
    if (!chars || !chars.length){ empty.style.display='block'; return; }

    grid.innerHTML = chars.map(c => `
      <a class="card" href="character.html?id=${c.id}">
        <div class="bd">
          <div style="font-weight:800">${escapeHTML(c.name)}</div>
          <div class="meta">${new Date(c.created_at).toLocaleString()} â€¢ ${escapeHTML(c.theme)}</div>
        </div>
      </a>
    `).join('');

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  })();
  </script>
</body>
</html>
