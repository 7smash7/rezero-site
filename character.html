<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Personnage — Re:Zero</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/zero.css">
</head>
<body class="zero" data-skin="crimson">
  <div class="container">
    <section class="hero">
      <h1 id="c-name" class="h-hero" style="font-size:3rem;margin:0">Chargement…</h1>
      <p class="h-sub" style="margin-top:8px">par <a id="c-owner" href="#">—</a> • <span id="c-date">—</span></p>
    </section>

    <div class="grid-2" style="margin-top:16px">
      <section class="card">
        <div class="hd">Fiche</div>
        <div class="bd">
          <table id="c-table" class="table"></table>
        </div>
      </section>

      <section class="card">
        <div class="hd">Stats</div>
        <div class="bd grid-3">
          <div class="card"><div class="bd"><div class="meta">Âge</div><div id="c-age" style="font-weight:800">—</div></div></div>
          <div class="card"><div class="bd"><div class="meta">Force</div><div id="c-strength" style="font-weight:800">—</div></div></div>
          <div class="card"><div class="bd"><div class="meta">Magie</div><div id="c-magic" style="font-weight:800">—</div></div></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="hd">Parcours</div>
        <div class="bd"><div id="c-steps" class="timeline"><div class="meta">—</div></div></div>
      </section>
    </div>

    <p id="msg" class="meta" style="color:#ff8aa8;margin-top:12px"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/nav.js"></script>

  <script>
  (async function(){
    const id = new URLSearchParams(location.search).get('id');
    const msg = document.getElementById('msg');
    if(!id){ msg.textContent="ID manquant dans l'URL."; return; }

    const { data: c, error } = await sb.from('characters').select('*').eq('id', id).single();
    if(error || !c){ msg.textContent="Personnage introuvable."; return; }

    document.getElementById('c-name').textContent = c.name || 'Sans nom';
    document.getElementById('c-date').textContent = new Date(c.created_at).toLocaleString();

    const ownerLink = document.getElementById('c-owner');
    const { data: [owner] } = await sb.from('profiles').select('username,display_name').eq('id', c.owner);
    if(owner && owner.username){ ownerLink.textContent='@'+owner.username; ownerLink.href='user.html?u='+encodeURIComponent(owner.username); }
    else { ownerLink.textContent = owner?.display_name || 'profil'; ownerLink.removeAttribute('href'); }

    const rows = {"Thème":c.theme,"Race":c.race,"Affiliation":c.affiliation,"Cheveux":c.hair,"Yeux":c.eyes,"Arme":c.weapon,"Magie":c.magic,"Trait distinctif":c.trait,"Personnalité":c.personality};
    document.getElementById('c-table').innerHTML = Object.entries(rows).map(([k,v])=>`<tr><th>${escapeHTML(k)}</th><td>${escapeHTML(v||'—')}</td></tr>`).join('');

    document.getElementById('c-age').textContent = c.age ?? '—';
    document.getElementById('c-strength').textContent = c.strength || '—';
    document.getElementById('c-magic').textContent = c.magic || '—';

    const steps = (c.timeline||'').split('\n').map(s=>s.trim()).filter(Boolean);
    document.getElementById('c-steps').innerHTML = steps.length ? steps.map(s=>`<div class="step">${escapeHTML(s)}</div>`).join('') : '<div class="meta">Aucune étape renseignée.</div>';

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  })();
  </script>
</body>
</html>
