<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Personnage – Re:Zero</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b0f18; --bg2:#141a2e; --txt:#e9eefc; --muted:#9aa4c7; --brd:rgba(255,255,255,.10);
      --panel:#121829; --panel2:#0f1424; --accent:#ff6b6b;
    }
    /* Thèmes */
    [data-theme="subaru"]{ --accent:#ff6b6b; --bg1:#0b0f18; --bg2:#141a2e; }
    [data-theme="emilia"]{ --accent:#8a67ff; --bg1:#f6f7ff; --bg2:#e9ebff; --txt:#202432; --muted:#6c7396; --panel:#ffffff; --panel2:#f4f5ff; --brd:rgba(32,36,50,.12); }
    [data-theme="rem"]{ --accent:#64b5f6; --bg1:#0a1428; --bg2:#173058; --panel:#0f1c34; --panel2:#0b1630; --brd:rgba(100,181,246,.22); }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);color:var(--txt)}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 0}
    .brand{font-weight:700;letter-spacing:.3px}
    .nav a{margin-left:14px}

    .hero{background:radial-gradient(ellipse at center, rgba(255,255,255,.06) 0%, transparent 70%);
      border:1px solid var(--brd);border-radius:16px;padding:28px;text-align:center}
    .hero .title{font-family:Cinzel,serif;font-weight:700;font-size:32px;letter-spacing:.04em}
    .hero .meta{margin-top:6px;color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--brd);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .card .hd{padding:16px 18px;border-bottom:1px solid var(--brd);font-weight:700}
    .card .bd{padding:16px 18px}

    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat{background:var(--panel2);border:1px solid var(--brd);border-radius:12px;padding:12px;text-align:center}
    .stat .k{color:var(--muted);font-size:12px}
    .stat .v{font-weight:700;margin-top:4px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--brd);text-align:left}
    th{color:var(--muted);font-weight:600;width:180px}
    .timeline .step{padding:12px 14px;border-left:3px solid var(--accent);background:var(--panel2);border-radius:0 12px 12px 0;margin:10px 0}

    .empty{color:var(--muted)}
    .err{color:#ff6b6b}
  </style>
</head>
<body data-theme="subaru">
  <div class="wrap">
    <!-- NAV -->
    <div class="topbar">
      <div class="brand">Re:Zero – Personnage</div>
      <div class="nav">
        <a href="index.html">Subaru</a>
        <a href="emilia.html">Emilia</a>
        <a href="rem.html">Rem</a>
        <a href="create.html"><b>Créer</b></a>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero" id="hero">
      <div class="title" id="c-name">Chargement…</div>
      <div class="meta">
        par <a id="c-owner" href="#">—</a> • <span id="c-date">—</span>
      </div>
    </section>

    <!-- CONTENU -->
    <div class="grid" id="content" style="display:none">
      <!-- FICHE -->
      <section class="card">
        <div class="hd">Fiche</div>
        <div class="bd">
          <table id="c-table">
            <!-- lignes injectées -->
          </table>
        </div>
      </section>

      <!-- STATS -->
      <section class="card">
        <div class="hd">Statistiques</div>
        <div class="bd">
          <div class="stats">
            <div class="stat"><div class="k">Âge</div><div class="v" id="c-age">—</div></div>
            <div class="stat"><div class="k">Force</div><div class="v" id="c-strength">—</div></div>
            <div class="stat"><div class="k">Magie</div><div class="v" id="c-magic">—</div></div>
          </div>
        </div>
      </section>

      <!-- TIMELINE -->
      <section class="card" style="grid-column:1 / -1">
        <div class="hd">Parcours</div>
        <div class="bd">
          <div id="c-steps" class="timeline"><div class="empty">—</div></div>
        </div>
      </section>
    </div>

    <p id="msg" class="err" style="margin-top:14px"></p>
  </div>

  <!-- 1) Librairie Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 2) Ton client partagé -->
  <script src="js/config.js"></script>

  <!-- 3) Logique d'affichage -->
  <script>
  (async function(){
    // Récupère l'ID dans l'URL
    const id = new URLSearchParams(location.search).get('id');
    const msg = document.getElementById('msg');
    if(!id){ msg.textContent = "ID manquant dans l'URL."; return; }

    // 1) Récupérer le personnage
    const { data: c, error } = await sb.from('characters').select('*').eq('id', id).single();
    if(error || !c){ msg.textContent = "Personnage introuvable."; return; }

    // 2) Appliquer le thème visuel
    document.body.setAttribute('data-theme', c.theme || 'subaru');

    // 3) Injecter titre + date + auteur
    document.getElementById('c-name').textContent = c.name || 'Sans nom';
    document.getElementById('c-date').textContent = new Date(c.created_at).toLocaleString();

    // Auteur (@username vers user.html), sinon simple texte
    const ownerLink = document.getElementById('c-owner');
    const { data: [owner] } = await sb
      .from('profiles').select('username,display_name').eq('id', c.owner);

    if(owner && owner.username){
      ownerLink.textContent = '@' + owner.username;
      ownerLink.href = 'user.html?u=' + encodeURIComponent(owner.username);
    } else {
      ownerLink.textContent = owner?.display_name || 'profil';
      ownerLink.removeAttribute('href');
    }

    // 4) Fiche (table de caractéristiques)
    const rows = {
      "Thème": c.theme,
      "Race": c.race,
      "Affiliation": c.affiliation,
      "Cheveux": c.hair,
      "Yeux": c.eyes,
      "Arme": c.weapon,
      "Magie": c.magic,
      "Trait distinctif": c.trait,
      "Personnalité": c.personality
    };
    const tbody = Object.entries(rows).map(([k,v]) =>
      `<tr><th>${escapeHTML(k)}</th><td>${escapeHTML(v || "—")}</td></tr>`
    ).join('');
    document.getElementById('c-table').innerHTML = tbody;

    // 5) Stats simples
    document.getElementById('c-age').textContent = c.age ?? '—';
    document.getElementById('c-strength').textContent = c.strength || '—';
    document.getElementById('c-magic').textContent = c.magic || '—';

    // 6) Timeline
    const steps = (c.timeline||'').split('\n').map(s=>s.trim()).filter(Boolean);
    const box = document.getElementById('c-steps');
    box.innerHTML = steps.length
      ? steps.map(s=>`<div class="step">${escapeHTML(s)}</div>`).join('')
      : '<div class="empty">Aucune étape renseignée.</div>';

    // Afficher le contenu une fois prêt
    document.getElementById('content').style.display = 'grid';

    // Utils
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  })();
  </script>
</body>
</html>
